name: Test Plugin Installation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-skill-syntax:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate SKILL.md YAML frontmatter
        run: |
          pip install pyyaml

          python3 << 'EOF'
          import yaml
          import sys
          from pathlib import Path

          errors = []

          for skill_file in Path("plugins").rglob("SKILL.md"):
              print(f"Checking {skill_file}...")
              content = skill_file.read_text()

              # Extract frontmatter between --- markers
              if not content.startswith("---"):
                  errors.append(f"{skill_file}: Missing frontmatter (must start with ---)")
                  continue

              parts = content.split("---", 2)
              if len(parts) < 3:
                  errors.append(f"{skill_file}: Invalid frontmatter (missing closing ---)")
                  continue

              frontmatter = parts[1].strip()

              try:
                  data = yaml.safe_load(frontmatter)
                  if not isinstance(data, dict):
                      errors.append(f"{skill_file}: Frontmatter must be a YAML dictionary")
                      continue

                  # Check required fields
                  if "name" not in data:
                      errors.append(f"{skill_file}: Missing required field 'name'")
                  if "description" not in data:
                      errors.append(f"{skill_file}: Missing required field 'description'")

                  print(f"  ✓ Valid: name={data.get('name')}")

              except yaml.YAMLError as e:
                  errors.append(f"{skill_file}: Invalid YAML: {e}")

          if errors:
              print("\n❌ Validation errors:")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)

          print("\n✓ All SKILL.md files are valid")
          EOF

  test-hypothesis-test-screens:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate hypothesis-test 6-screen flow
        run: |
          skill="plugins/hypothesis-test/skills/hypothesis-test/SKILL.md"
          echo "Checking hypothesis-test orchestrator has all 6 screens..."

          for screen in \
            "## Pre-Screen Detection" \
            "## Screen 1:" \
            "## Post-Screen 1:" \
            "## Screen 2:" \
            "## Screen 3:" \
            "## Screen 4:" \
            "## Screen 5:" \
            "## Screen 6:"; do
            if ! grep -q "$screen" "$skill"; then
              echo "ERROR: Missing '$screen' section in $skill"
              exit 1
            fi
            echo "  ✓ Found $screen"
          done

          echo ""
          echo "Checking all 4 internal skills exist..."
          for internal_skill in _formulate-hypothesis _scaffold-experiment _run-and-analyze _document-findings; do
            skill_path="plugins/hypothesis-test/skills/$internal_skill/SKILL.md"
            if [ ! -f "$skill_path" ]; then
              echo "ERROR: Missing internal skill $skill_path"
              exit 1
            fi
            echo "  ✓ $internal_skill"
          done

          echo ""
          echo "Checking background agent patterns in Screen 2, 4, 5..."
          for screen_label in "Screen 2" "Screen 4" "Screen 5"; do
            if ! grep -A 30 "## $screen_label:" "$skill" | grep -q "run_in_background"; then
              echo "ERROR: $screen_label should use background agents (run_in_background) but pattern not found"
              exit 1
            fi
            echo "  ✓ $screen_label uses background agents"
          done

          echo ""
          echo "✓ hypothesis-test orchestrator is valid"

  test-plugin-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate plugin can be loaded
        run: |
          echo "Validating plugin structure for Claude Code compatibility..."

          # Check marketplace.json references valid plugins
          for plugin_path in $(jq -r '.plugins[].source' .claude-plugin/marketplace.json); do
            echo "Checking plugin: $plugin_path"

            # Verify plugin.json exists and has required fields
            plugin_json="$plugin_path/.claude-plugin/plugin.json"
            if [ ! -f "$plugin_json" ]; then
              echo "ERROR: Missing $plugin_json"
              exit 1
            fi

            name=$(jq -r '.name' "$plugin_json")
            version=$(jq -r '.version' "$plugin_json")

            if [ "$name" = "null" ] || [ -z "$name" ]; then
              echo "ERROR: Missing 'name' in $plugin_json"
              exit 1
            fi

            if [ "$version" = "null" ] || [ -z "$version" ]; then
              echo "ERROR: Missing 'version' in $plugin_json"
              exit 1
            fi

            echo "  ✓ Plugin: $name v$version"

            # Check skills directory has at least one skill (public or internal)
            all_skills=$(find "$plugin_path/skills" -maxdepth 1 -type d ! -name "skills" | wc -l)
            public_skills=$(find "$plugin_path/skills" -maxdepth 1 -type d ! -name "_*" ! -name "skills" | wc -l)
            if [ "$all_skills" -eq 0 ]; then
              echo "ERROR: No skills found in $plugin_path/skills"
              exit 1
            fi

            echo "  ✓ Found $public_skills public + $((all_skills - public_skills)) internal skill(s)"
          done

          echo ""
          echo "✓ All plugins are valid"
